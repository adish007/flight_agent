# Dad Flight Agent

## What This Is

A flight search agent that scrapes Google Flights to find the cheapest round-trip flights from Boston (BOS) to 10 Caribbean destinations for May 2026. Built for 2 passengers, economy class, with a max travel time of 10 hours per leg.

## How It Works

**Two-phase architecture:**

1. **Phase 1 — Leg Search:** Searches each one-way leg independently (outbound BOS→dest and return dest→BOS) using `fast-flights` library. Runs ~620 searches with 3 parallel workers. Saves raw results to `legs.csv`.

2. **Phase 2 — Post-processing:** Combines the cheapest outbound flight per (destination, date) with the cheapest return flight for each trip length (3, 4, 5, 6 days). Outputs sorted round-trip combinations to `flights_filtered.csv`.

Return dates extend into June to cover late-May departures with 3–6 day trips.

## Running

```bash
pip install -r requirements.txt
python main.py
```

Supports Ctrl+C — progress is saved to `progress.json` and resumes on next run. Delete `progress.json` and `legs.csv` to start fresh.

## Project Structure

```
config.py           — All configuration (destinations, dates, trip lengths, workers)
scraper.py          — Google Flights scraper using fast-flights library
filter_and_rank.py  — Filter by duration, sort by price
exporter.py         — CSV export with round-trip columns
main.py             — Orchestrator: parallel leg search + round-trip post-processing
tests/              — pytest tests (15 total)
```

## Key Technical Details

- **fast-flights**: Must use `fetch_mode='fallback'` — the default `'common'` mode returns empty airline/duration/time fields.
- **Scraper returns raw strings**: `parse_duration_hrs()`, `parse_price()`, `parse_stops()` in `main.py` handle conversion. `parse_stops` must handle both `int` and `str` inputs.
- **Deduplication** happens at two levels: in `scraper.py` (same flight returned multiple times) and in `main.py` (same airline + departure + price).
- **Config** is the single source of truth for destinations, dates, limits, and output paths. Tests validate config values directly.
- **No API keys needed** — fast-flights scrapes Google Flights directly (free).

## Output Files

- `legs.csv` — Raw one-way leg data (intermediate, gitignored)
- `flights_filtered.csv` — Final round-trip combinations sorted by total price (gitignored)
- `flights_report.xlsx` — Formatted Excel report with two tabs: "All Airlines" (top 5 per destination) and "No Budget Airlines" (same but excluding Frontier/Spirit). Generated by `build_excel_report()` in `main.py`. (gitignored)
- `progress.json` — Resume state (gitignored)
- `errors.log` — Failed searches (gitignored)

## Tests

```bash
pytest tests/ -v
```

All tests are unit tests with no network calls. Tests cover config values, filtering logic, and CSV export.

## Past Issues Worth Knowing

- AA.com was the original target but Akamai bot protection blocks all automated access (Playwright, curl, CDP). That's why we pivoted to Google Flights.
- `fast-flights` API: use `get_flights()` with keyword args (`flight_data=`, `trip=`, `passengers=`, `seat=`). There is no `Result.from_data()` method.
- Python 3.14 breaks `nodriver` and `undetected-chromedriver` — not relevant anymore but worth noting if dependencies change.
